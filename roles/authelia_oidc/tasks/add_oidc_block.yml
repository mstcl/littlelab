---
- name: Clear facts
  tags: ["authelia", "oidc"]
  ansible.builtin.set_fact:
    expanded_url: ""

- name: Get url
  tags: ["authelia", "oidc"]
  ansible.builtin.include_role:
    name: urls

- name: Get variables
  tags: ["authelia", "oidc"]
  ansible.builtin.include_vars:
    file: "{{ vars_file }}"

- name: Add an OIDC block to Authelia configuration
  tags: ["authelia", "oidc"]
  become: true
  ansible.builtin.blockinfile:
    state: present
    insertafter: "    clients:"
    dest: "{{ base_directory }}/authelia/config/configuration.yml"
    marker: "      # {mark} {{ service_name|upper }} CONFIGURATION"
    content: |2
            - id: {{ oidc.id }}
              description: {{ service_name }}
              secret: '{{ oidc.digest }}'
              public: false
              authorization_policy: two_factor
              redirect_uris:
      {% for uri in oidc.redirect_uris %}
                - {{ uri }}
      {% endfor %}
              scopes:
      {% if scopes is undefined %}
                - openid
                - profile
                - groups
                - email
      {% else %}
      {% for scope in item.scopes %}
                - {{ scope }}
      {% endfor %}
      {% endif %}
              userinfo_signing_algorithm: none
