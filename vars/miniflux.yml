---
service_directory: "miniflux"
image: "miniflux/miniflux:2.1.2"
urls_url: "{{ urls.miniflux }}"

state: started

authelia_oidc_client_id: "{{ lookup('get_secrets', path='/miniflux', secret_name='MINIFLUX_OIDC_ID') }}"
authelia_oidc_client_secret: "{{ lookup('get_secrets', path='/miniflux', secret_name='MINIFLUX_OIDC_SECRET') }}"
authelia_oidc_digest: "{{ lookup('get_secrets', path='/authelia', secret_name='AUTHELIA_MINIFLUX_DIGEST') }}"
authelia_oidc_redirect_uris:
  - "https://{{ expanded_url }}/oauth2/oidc/callback"

docker_attach_postgres: true
docker_postgres_image: "postgres:15-alpine"
docker_postgres_db: "{{ service_directory }}"
docker_postgres_user: "{{ lookup('get_secrets', path='/miniflux', secret_name='MINIFLUX_POSTGRES_USER') }}"
docker_postgres_password: "{{ lookup('get_secrets', path='/miniflux', secret_name='MINIFLUX_POSTGRES_PASSWORD') }}"
docker_postgres_location: "{{ location.docker_data }}/{{ service_directory }}/db"

config_directories:
  - path: "{{ docker_postgres_location }}"
    owner: "70"
    permission: "0700"

docker_env:
  DATABASE_URL: "postgres://{{ docker_postgres_user }}:{{ docker_postgres_password }}@{{ service_directory }}-postgres/{{ docker_postgres_db }}?sslmode=disable"
  BASE_URL: "https://{{ expanded_url }}"
  RUN_MIGRATIONS: "1"
  OAUTH2_PROVIDER: "oidc"
  OAUTH2_CLIENT_ID: "{{ authelia_oidc_client_id }}"
  OAUTH2_CLIENT_SECRET: "{{ authelia_oidc_client_secret }}"
  OAUTH2_REDIRECT_URL: "{{ authelia_oidc_redirect_uris[0] }}"
  OAUTH2_OIDC_DISCOVERY_ENDPOINT: "https://{{ urls.authelia.sub }}.{{ base_tld }}"
  OAUTH2_USER_CREATION: "0"
docker_network_internal: false

traefik_middlewares:
  - "internal@file"
