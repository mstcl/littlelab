---
- name: Install authelia
  hosts: homelab
  gather_facts: false
  vars_files:
    - vars/authelia.yml
  vars:
    service_directory: "authelia"
    image: "docker.io/authelia/authelia:4.37.5"
    url: "{{ urls.authelia }}"
    # DEFAULTS
    permissions: &permissions
      owner: "4100"
      permission: "0600"
    secret_permissions: &secret_permissions
      <<: *permissions
      destination_path: "{{ base_directory }}/{{ service_directory }}/secrets"

  pre_tasks:
    - name: Check for users configuration
      ansible.builtin.stat:
        path: "{{ base_directory }}/{{ service_directory }}/config/users.yml"
      register: config_results

  roles:
    - role: users
      vars:
        users:
          - name: "authelia"
            uid: 4100
    - role: urls
    - role: config
      become: true
      vars:
        directories:
          - path: "{{ base_directory }}/{{ service_directory }}/config"
          - path: "{{ base_directory }}/{{ service_directory }}/secrets"
          - path: "{{ location.docker_data }}/{{ service_directory }}/data"
            owner: "4100"
        files:
          - destination_path: "{{ base_directory }}/{{ service_directory }}/config"
            <<: *permissions
          - template_name: "AUTHELIA_JWT_SECRET"
            <<: *secret_permissions
          - template_name: "AUTHELIA_SESSION_SECRET"
            <<: *secret_permissions
          - template_name: "AUTHELIA_STORAGE_ENCRYPTION_KEY"
            <<: *secret_permissions
          - template_name: "AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET"
            <<: *secret_permissions
          - template_name: "AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET"
            <<: *secret_permissions
          - template_name: "AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY"
            <<: *secret_permissions
    - role: config
      when: not config_results.stat.exists
      vars:
        copy:
          - file_name: "users.yml"
            destination_path: "{{ base_directory }}/{{ service_directory }}/config"
            <<: *permissions
    - role: docker
    - role: traefik
      vars:
        servers:
          - port: 9091
        middlewares:
          - "internal-ip@file"
        additional_content: |2
            middlewares:
              authelia:
                forwardAuth:
                  address: "http://authelia:9091/api/verify?rd=https%3A%2F%2F{{ expanded_url }}%2F"
                  trustForwardHeader: true
                  authResponseHeaders: ["Remote-User","Remote-Groups","Remote-Name","Remote-Email"]
              authelia-basic:
                forwardAuth:
                  address: "http://authelia:9091/api/verify?auth=basic"
                  trustForwardHeader: true
                  authResponseHeaders: ["Remote-User","Remote-Groups","Remote-Name","Remote-Email"]
    - role: authelia
      vars:
        url: "{{ urls.portainer }}"
        service_name: "Portainer"
        vars_file: "vars/portainer.yml"
    - role: authelia
      vars:
        url: "{{ urls.miniflux }}"
        service_name: "Miniflux"
        vars_file: "vars/miniflux.yml"
    - role: authelia
      vars:
        url: "{{ urls.immich }}"
        service_name: "Immich"
        redirect_uris:
          - https://{{ expanded_url }}/auth/login
          - https://{{ expanded_url }}/user-settings
          - https://{{ expanded_url }}/api/oauth/mobile-redirect
          - app.immich://
    - role: authelia
      vars:
        url: "{{ urls.sftpgo }}"
        service_name: "Sftpgo"
        vars_file: "vars/sftpgo.yml"
    - role: cron
