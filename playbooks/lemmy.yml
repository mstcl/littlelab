---
- name: Install lemmy
  hosts: homelab
  gather_facts: false
  vars_files:
    - vars/lemmy.yml
  vars:
    service_directory: "lemmy"
    image: "dessalines/lemmy:0.18.5"
    url: "{{ urls.lemmy }}"

  roles:
    - role: urls
    - role: config
      become: true
      vars:
        directories:
          -
          - path: "{{ db_location }}"
            owner: "70"
            permission: "0700"
          - path: "{{ location.docker_data }}/{{ service_directory }}/pictrs"
            owner: "991"
          - path: "{{ base_directory }}/{{ service_directory}}/css"
        files: [{}]
    - role: docker
      vars:
        attach_postgres: true
        run: false
        postgres_location: "{{ db_location }}"
    - role: nginx
      vars:
        configs:
          - config_name: "lemmy"
            server_url: "{{ urls.lemmy.sub }}.{{ base_tld }}"
    - role: traefik
      vars:
        create_service: false
        service_name: "nginx-lemmy"

  post_tasks:
    - name: Fetch lemmy css
      tags: css
      ansible.builtin.get_url:
        url: https://codeberg.org/lckdscl/selfhosted_userstyles/raw/branch/master/jumper/lemmy/{{ item }}
        dest: "{{ base_directory }}/{{ service_directory }}/css/{{ item }}"
        mode: "0644"
      loop:
        - "_variables.whiskers_v8.scss"
        - "whiskers_v8.css"
        - "whiskers_v8.scss"

    - name: Start compose file
      tags: ["docker", "deploy"]
      ansible.builtin.include_tasks: roles/docker/tasks/down_and_up.yml
      vars:
        force_up: true
