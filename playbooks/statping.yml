---
- name: Install statping
  hosts: homelab
  gather_facts: false
  vars:
    service_directory: "statping"
    service_image: "adamboutcher/statping-ng"
    image_tag: "latest"
    url: "{{ urls.statping }}"
    config_file: "services.yml"
    instance_name: "BIM status page"
    api_key: "{{ lookup('get_secrets', path='/statping', secret_name='STATPING_API') }}"
    user: "{{ lookup('get_secrets', path='/statping', secret_name='STATPING_USER') }}"
    password: "{{ lookup('get_secrets', path='/statping', secret_name='STATPING_PASSWORD') }}"

  pre_tasks:
    - name: Get list of services
      ansible.builtin.set_fact:
        all_names: "{% if url.monitor is defined %}{{ all_names | default([]) + [item.key|capitalize]}}{% else %}{{ all_names | default([]) }}{% endif %}"
      vars:
        url: "{{ item.value }}"
      loop: "{{ urls | dict2items }}"
    - name: Get list of urls
      ansible.builtin.include_role:
        name: urls
      vars:
        url: "{{ item.value }}"
        accumulate: true
        type: "monitor"
      loop: "{{ urls | dict2items }}"

  roles:
    - role: urls
    - role: config
      vars:
        directories: [{}]
        files: [{}]
    - role: docker
    - role: traefik
      vars:
        servers: [{}]
