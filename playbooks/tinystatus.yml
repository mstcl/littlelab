---
- name: Install tinystatus
  hosts: homelab
  gather_facts: false
  vars:
    service_directory: "tinystatus"
    url: "{{ urls.tinystatus }}"

  pre_tasks:
    - name: Get list of services
      ansible.builtin.set_fact:
        all_names: "{% if url.monitor is defined %}{{ all_names | default([]) + [item.key|capitalize]}}{% else %}{{ all_names | default([]) }}{% endif %}"
      vars:
        url: "{{ item.value }}"
      loop: "{{ urls | dict2items }}"
    - name: Get list of urls
      ansible.builtin.include_role:
        name: urls
      vars:
        url: "{{ item.value }}"
        accumulate: true
        type: "monitor"
      loop: "{{ urls | dict2items }}"

    - name: Check for tinystatus repo
      ansible.builtin.stat:
        path: "{{ base_directory }}/{{ service_directory }}/tinystatus"
      register: clone_results

    - name: Install dependencies
      tags: packages
      ansible.builtin.include_role:
        name: packages
      vars:
        native:
          - gnu-netcat

  roles:
    - role: git
      vars:
        repo: https://github.com/mstcl/tinystatus.git
        destination: "{{ base_directory }}/{{ service_directory }}/tinystatus"
        branch: master
      when: not clone_results.stat.exists
    - role: config
      vars:
        files:
          - template_name: "checks.csv"
            destination_path: "{{ base_directory }}/{{ service_directory }}/tinystatus"
          - template_name: "tinystatus_cron.sh"
            destination_path: "{{ base_directory }}/scripts"
            permission: "0555"
    - role: config
      tags: incident
      vars:
        copies:
          - file_name: "incidents.txt"
            destination_path: "{{ base_directory }}/{{ service_directory }}/tinystatus"
      notify: Regenerate page

  post_tasks:
    - name: Make crontab for tinystatus
      tags: cron
      ansible.builtin.cron:
        name: "Update statuspage"
        minute: "*/2"
        job: "{{ base_directory }}/scripts/tinystatus_cron.sh > /dev/null || \
          {{ base_directory }}/scripts/alert.sh 'ERROR: tinystatus failed!'"

  handlers:
    - name: Regenerate page
      ansible.builtin.command:
        command:
          "{{ base_directory }}/scripts/tinystatus_cron.sh"
    - import_tasks: ../roles/docker/handlers/main.yml
